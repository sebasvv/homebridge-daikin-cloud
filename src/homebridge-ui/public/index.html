<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Daikin Cloud Configuration</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { padding: 20px; }
        .card { margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="card">
    <div class="card-header">
        Daikin Cloud Credentials
    </div>
    <div class="card-body">
        <form id="configForm">
            <div class="form-group">
                <label for="clientId">Client ID</label>
                <input type="text" class="form-control" id="clientId" placeholder="Enter Client ID from Daikin Developer Portal" required>
                <small class="form-text text-muted">Get this from the <a href="https://developer.cloud.daikineurope.com/" target="_blank">Daikin Developer Portal</a>.</small>
            </div>
            <div class="form-group">
                <label for="clientSecret">Client Secret</label>
                <input type="password" class="form-control" id="clientSecret" placeholder="Enter Client Secret" required>
            </div>
            
            <hr>
            
            <h5>Authorization</h5>
            <p>You need to authorize this plugin to access your Daikin account.</p>
            
            <div class="form-group">
                <label for="callbackUrl">Callback URL (Redirect URI)</label>
                <input type="text" class="form-control" id="callbackUrl" placeholder="https://YOUR_HOMEBRIDGE_IP:8582" required>
                <small class="form-text text-muted">Must match exactly what you set in the Daikin Portal.</small>
            </div>

            <button type="button" class="btn btn-primary" id="btnGetAuthUrl">1. Get Authorization URL</button>
            
            <div id="authUrlSection" class="mt-3" style="display:none;">
                <label>Copy and open this URL in your browser if not opened automatically:</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="generatedAuthUrl" readonly>
                    <div class="input-group-append">
                        <a href="#" class="btn btn-outline-secondary" id="openAuthLink" target="_blank">Open</a>
                    </div>
                </div>
                <small class="text-info">After logging in, you should be redirected to a page that might fail or show a code. This plugin will try to capture the token if the callback server is running, otherwise you might need manually copy the code (future feature).</small>
            </div>
        </form>
    </div>
</div>

<script>
(async () => {
    // 1. Get current config
    const pluginConfig = await window.homebridge.getPluginConfig();
    const config = pluginConfig[0] || {};

    // 2. Populate form
    document.getElementById('clientId').value = config.clientId || '';
    document.getElementById('clientSecret').value = config.clientSecret || '';
    document.getElementById('callbackUrl').value = config.callbackServerExternalAddress 
        ? `https://${config.callbackServerExternalAddress}:${config.callbackServerPort || 8582}` 
        : window.location.protocol + '//' + window.location.hostname + ':8582';

    // 3. Handle Auth URL generation
    document.getElementById('btnGetAuthUrl').addEventListener('click', async () => {
        const clientId = document.getElementById('clientId').value;
        const callbackUrl = document.getElementById('callbackUrl').value;

        if (!clientId || !callbackUrl) {
            window.homebridge.toast.error('Please fill Client ID and Callback URL first.');
            return;
        }

        try {
            const response = await window.homebridge.request('/auth-url', {
                clientId,
                callbackUrl
            });
            
            document.getElementById('generatedAuthUrl').value = response.url;
            document.getElementById('openAuthLink').href = response.url;
            document.getElementById('authUrlSection').style.display = 'block';
            window.open(response.url, '_blank');
        } catch (e) {
            window.homebridge.toast.error(e.message);
        }
    });

    // 4. Save Config
    // This UI currently just helps generating the URL, but saving is handled by standard Config UI 'Save' button 
    // effectively merging this form data back? 
    // Actually, Custom UI replaces the standard form. We need to implement 'onChange' to update the plugin config object.
    
    function updateConfig() {
         const newConfig = {
            ...config,
            clientId: document.getElementById('clientId').value,
            clientSecret: document.getElementById('clientSecret').value,
            // Parse callback URL to extract address/port if user changed it?
            // For simplicity, let's keep it simple for now or parsing manually
         };
         window.homebridge.updatePluginConfig([newConfig]);
    }

    ['clientId', 'clientSecret'].forEach(id => {
        document.getElementById(id).addEventListener('input', updateConfig);
    });

})();
</script>

</body>
</html>
